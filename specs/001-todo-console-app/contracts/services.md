# Service Contracts: In-Memory Todo Console Application

**Feature**: 001-todo-console-app
**Created**: 2026-01-02
**Purpose**: Define internal function signatures for all modules (data, storage, business logic, UI layers)

## Overview

This document specifies the public interfaces for all modules in the todo application. These contracts serve as the implementation blueprint and ensure strict layer separation per constitution principle II.

---

## Module: `src/models.py`

**Purpose**: Data structures only (no logic, no I/O)

### Class: `TodoItem`

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Literal

TodoStatus = Literal["pending", "completed"]

@dataclass
class TodoItem:
    """
    Represents a single todo task.

    Attributes:
        id: Unique identifier (auto-generated by TodoStore)
        title: Main task description (required, non-empty)
        description: Optional additional details
        status: Completion status ("pending" or "completed")
        created_at: Timestamp when todo was created
    """
    id: int
    title: str
    description: str | None
    status: TodoStatus
    created_at: datetime
```

**Notes**:
- No methods beyond auto-generated dataclass methods (`__init__`, `__repr__`, `__eq__`)
- Immutability not enforced (`frozen=False`) to allow updates
- Type hints required on all fields

---

## Module: `src/store.py`

**Purpose**: In-memory storage operations only (no validation logic, no I/O)

### Class: `TodoStore`

```python
from src.models import TodoItem

class TodoStore:
    """
    Manages in-memory collection of todo items.

    Provides CRUD operations with auto-incrementing ID generation.
    Thread-safety not required (single-threaded console app).
    """

    def __init__(self) -> None:
        """
        Initialize empty todo store with ID counter starting at 1.
        """
        ...

    def add(self, title: str, description: str | None = None) -> TodoItem:
        """
        Add a new todo item to the store.

        Args:
            title: Task description (can be empty; validation happens in services layer)
            description: Optional additional details

        Returns:
            TodoItem: The newly created todo with auto-generated ID and timestamp

        Notes:
            - ID auto-incremented (monotonic, never reused)
            - Status defaults to "pending"
            - created_at set to current local time
        """
        ...

    def get_all(self) -> list[TodoItem]:
        """
        Retrieve all todo items.

        Returns:
            list[TodoItem]: All todos in insertion order (empty list if none)
        """
        ...

    def get_by_id(self, todo_id: int) -> TodoItem:
        """
        Retrieve a specific todo by ID.

        Args:
            todo_id: The unique identifier of the todo

        Returns:
            TodoItem: The matching todo

        Raises:
            KeyError: If no todo with the given ID exists
        """
        ...

    def update(
        self,
        todo_id: int,
        title: str | None = None,
        description: str | None = None
    ) -> TodoItem:
        """
        Update title and/or description of an existing todo.

        Args:
            todo_id: The unique identifier of the todo to update
            title: New title (if None, keeps existing title)
            description: New description (if None, keeps existing description)

        Returns:
            TodoItem: The updated todo

        Raises:
            KeyError: If no todo with the given ID exists

        Notes:
            - ID and created_at cannot be modified
            - Status unchanged (use mark_completed for status changes)
            - Passing None means "keep existing value"
        """
        ...

    def mark_completed(self, todo_id: int) -> TodoItem:
        """
        Mark a todo as completed (change status to "completed").

        Args:
            todo_id: The unique identifier of the todo

        Returns:
            TodoItem: The updated todo with status="completed"

        Raises:
            KeyError: If no todo with the given ID exists

        Notes:
            - Idempotent (marking already-completed todo is allowed)
            - One-way transition (no "uncomplete" in Phase I)
        """
        ...

    def delete(self, todo_id: int) -> None:
        """
        Permanently remove a todo from the store.

        Args:
            todo_id: The unique identifier of the todo to delete

        Raises:
            KeyError: If no todo with the given ID exists

        Notes:
            - Deleted IDs are never reused
            - Operation is permanent (no undo in Phase I)
        """
        ...
```

---

## Module: `src/services.py`

**Purpose**: Business logic and validation (no I/O, delegates to store)

**Import Requirements**:
```python
from src.store import TodoStore
from src.models import TodoItem
```

### Function: `create_todo`

```python
def create_todo(
    store: TodoStore,
    title: str,
    description: str | None = None
) -> TodoItem:
    """
    Create a new todo with validation.

    Args:
        store: The TodoStore instance
        title: Task description (will be validated)
        description: Optional additional details

    Returns:
        TodoItem: The newly created todo

    Raises:
        ValueError: If title is empty after stripping whitespace

    Example:
        >>> todo = create_todo(store, "Buy groceries", "Milk, eggs")
        >>> todo.id
        1
        >>> todo.status
        'pending'
    """
    ...
```

### Function: `list_todos`

```python
def list_todos(store: TodoStore) -> list[TodoItem]:
    """
    Retrieve all todos from the store.

    Args:
        store: The TodoStore instance

    Returns:
        list[TodoItem]: All todos (empty list if none)

    Notes:
        - No pagination in Phase I
        - Todos returned in insertion order
        - No validation needed (delegates directly to store)
    """
    ...
```

### Function: `mark_as_completed`

```python
def mark_as_completed(store: TodoStore, todo_id: int) -> TodoItem:
    """
    Mark a todo as completed with validation.

    Args:
        store: The TodoStore instance
        todo_id: The ID of the todo to mark complete

    Returns:
        TodoItem: The updated todo with status="completed"

    Raises:
        KeyError: If todo with given ID doesn't exist (from store layer)

    Notes:
        - Idempotent (safe to call on already-completed todos)
        - Services layer passes through KeyError from store
    """
    ...
```

### Function: `update_todo`

```python
def update_todo(
    store: TodoStore,
    todo_id: int,
    new_title: str | None = None,
    new_description: str | None = None
) -> TodoItem:
    """
    Update todo title and/or description with validation.

    Args:
        store: The TodoStore instance
        todo_id: The ID of the todo to update
        new_title: New title (if provided, will be validated; None keeps existing)
        new_description: New description (None keeps existing)

    Returns:
        TodoItem: The updated todo

    Raises:
        KeyError: If todo with given ID doesn't exist
        ValueError: If new_title is provided but empty after stripping

    Example:
        >>> todo = update_todo(store, 1, new_title="Buy groceries and snacks")
        >>> todo.title
        'Buy groceries and snacks'
    """
    ...
```

### Function: `delete_todo`

```python
def delete_todo(store: TodoStore, todo_id: int) -> None:
    """
    Delete a todo with validation.

    Args:
        store: The TodoStore instance
        todo_id: The ID of the todo to delete

    Raises:
        KeyError: If todo with given ID doesn't exist

    Notes:
        - Permanent deletion (no undo)
        - Services layer passes through KeyError from store
    """
    ...
```

---

## Module: `src/cli.py`

**Purpose**: User interface logic only (all I/O, delegates to services, no business logic)

**Import Requirements**:
```python
from src.store import TodoStore
from src.services import (
    create_todo,
    list_todos,
    mark_as_completed,
    update_todo,
    delete_todo
)
```

### Function: `display_menu`

```python
def display_menu() -> None:
    """
    Display the main menu options to the user.

    Output format:
        === Todo Application ===
        1. Add Todo
        2. List Todos
        3. Mark Todo as Completed
        4. Update Todo
        5. Delete Todo
        6. Exit

        Enter your choice (1-6):
    """
    ...
```

### Function: `get_menu_choice`

```python
def get_menu_choice() -> int:
    """
    Prompt user for menu choice and return validated integer.

    Returns:
        int: User's menu choice (1-6)

    Notes:
        - Loops until valid integer is entered
        - Displays friendly error for non-numeric input
        - Does NOT validate range (handled by main loop)
    """
    ...
```

### Function: `handle_add_todo`

```python
def handle_add_todo(store: TodoStore) -> None:
    """
    Handle the "Add Todo" user interaction.

    Prompts:
        - "Enter todo title: "
        - "Enter description (optional, press Enter to skip): "

    Args:
        store: The TodoStore instance

    Side Effects:
        - Calls services.create_todo()
        - Prints success message with new todo ID
        - Prints error message if validation fails (empty title)

    Example Output:
        ✓ Todo #1 created successfully!
        Or:
        ✗ Error: Title cannot be empty. Please try again.
    """
    ...
```

### Function: `handle_list_todos`

```python
def handle_list_todos(store: TodoStore) -> None:
    """
    Handle the "List Todos" user interaction.

    Args:
        store: The TodoStore instance

    Side Effects:
        - Calls services.list_todos()
        - Prints formatted list of todos (or "No todos yet" if empty)

    Example Output:
        === Your Todos ===
        [1] Buy groceries (Pending)
            Created: 2026-01-02 10:30:15
            Description: Milk, eggs, bread

        [2] Read book (Completed)
            Created: 2026-01-02 11:45:22

        Or:
        No todos yet. Add your first task!
    """
    ...
```

### Function: `handle_mark_completed`

```python
def handle_mark_completed(store: TodoStore) -> None:
    """
    Handle the "Mark Todo as Completed" user interaction.

    Prompts:
        - "Enter todo ID to mark as completed: "

    Args:
        store: The TodoStore instance

    Side Effects:
        - Calls services.mark_as_completed()
        - Prints success message
        - Prints error message if ID not found or invalid input

    Example Output:
        ✓ Todo #2 marked as completed!
        Or:
        ✗ Error: Todo #999 not found.
        Or:
        ✗ Error: Invalid ID. Please enter a number.
    """
    ...
```

### Function: `handle_update_todo`

```python
def handle_update_todo(store: TodoStore) -> None:
    """
    Handle the "Update Todo" user interaction.

    Prompts:
        - "Enter todo ID to update: "
        - "Enter new title (or press Enter to keep current): "
        - "Enter new description (or press Enter to keep current): "

    Args:
        store: The TodoStore instance

    Side Effects:
        - Calls services.update_todo()
        - Prints success message
        - Prints error message if ID not found or validation fails

    Example Output:
        ✓ Todo #1 updated successfully!
        Or:
        ✗ Error: Todo #999 not found.
    """
    ...
```

### Function: `handle_delete_todo`

```python
def handle_delete_todo(store: TodoStore) -> None:
    """
    Handle the "Delete Todo" user interaction.

    Prompts:
        - "Enter todo ID to delete: "
        - "Are you sure? This cannot be undone (y/n): "

    Args:
        store: The TodoStore instance

    Side Effects:
        - Calls services.delete_todo() if user confirms
        - Prints success message or cancellation message
        - Prints error message if ID not found or invalid input

    Example Output:
        ✓ Todo #3 deleted successfully!
        Or:
        Deletion cancelled.
        Or:
        ✗ Error: Todo #999 not found.
    """
    ...
```

### Function: `run_cli`

```python
def run_cli() -> None:
    """
    Main CLI loop for the todo application.

    Side Effects:
        - Creates TodoStore instance
        - Displays menu in loop
        - Routes user choices to appropriate handlers
        - Handles Ctrl+C gracefully (exit message)
        - Exits on choice 6 with goodbye message

    Example Output (on exit):
        Goodbye! Your todos were in-memory only (all data lost).

    Notes:
        - Infinite loop until user exits or Ctrl+C
        - Invalid menu choices display error and re-prompt
        - Catches and displays user-friendly messages for all exceptions
    """
    ...
```

---

## Module: `main.py`

**Purpose**: Application entry point

```python
from src.cli import run_cli

def main() -> None:
    """
    Entry point for the todo application.

    Launches the CLI interface.
    """
    run_cli()

if __name__ == "__main__":
    main()
```

---

## Exception Handling Contract

**Layering Rules**:
1. **Store Layer**: Raises `KeyError` for non-existent IDs (no custom exceptions in Phase I)
2. **Services Layer**: Raises `ValueError` for validation failures; passes through `KeyError` from store
3. **CLI Layer**: Catches all exceptions and displays user-friendly error messages (no stack traces shown to user)

**Error Message Format**:
- Success: `✓ <Message>`
- Error: `✗ Error: <Detailed message>`

**Examples**:
```python
# Store layer
def get_by_id(self, todo_id: int) -> TodoItem:
    ...
    raise KeyError(f"Todo #{todo_id} not found")

# Services layer
def create_todo(store: TodoStore, title: str, ...) -> TodoItem:
    if not title.strip():
        raise ValueError("Title cannot be empty")
    ...

# CLI layer
try:
    create_todo(store, title, description)
    print("✓ Todo created successfully!")
except ValueError as e:
    print(f"✗ Error: {e}")
except KeyError as e:
    print(f"✗ Error: {e}")
```

---

## Type Checking Compliance

All functions MUST include:
- Type hints on all parameters
- Return type annotation
- Docstring with Args/Returns/Raises sections

**Example**:
```python
def create_todo(
    store: TodoStore,  # Type hint
    title: str,        # Type hint
    description: str | None = None  # Type hint with default
) -> TodoItem:  # Return type annotation
    """
    Create a new todo with validation.  # Summary

    Args:  # Arguments documented
        store: The TodoStore instance
        title: Task description (will be validated)
        description: Optional additional details

    Returns:  # Return value documented
        TodoItem: The newly created todo

    Raises:  # Exceptions documented
        ValueError: If title is empty after stripping whitespace
    """
    ...
```

---

## Constitution Compliance Verification

**Principle II (Separation of Concerns)**:
- ✅ `models.py`: ZERO I/O, ZERO validation logic
- ✅ `store.py`: ZERO I/O, ZERO validation logic
- ✅ `services.py`: ZERO `input()` or `print()` calls
- ✅ `cli.py`: ZERO business logic (delegates to services)

**Principle III (Readability)**:
- ✅ All functions have docstrings
- ✅ All parameters have type hints
- ✅ Descriptive names (`create_todo`, not `create`, not `c_todo`)

**Principle V (Extensibility)**:
- ✅ Services layer functions map directly to future API endpoints
- ✅ Store methods map to future repository pattern
- ✅ Data model aligns with future database schema

---

## Notes

- These contracts are the source of truth for implementation
- All functions must be implemented exactly as specified (signatures, exceptions, return types)
- CLI layer has the most freedom in output formatting (as long as messages are user-friendly)
- Store and services layers have strict contracts to ensure clean Phase II migration
